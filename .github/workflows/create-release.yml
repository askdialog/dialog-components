name: Create GitHub Release

on:
  push:
    tags:
      - '@askdialog/**'

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract package info from tag
        id: tag_info
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          # Extract package name and version
          # Tag format: @askdialog/package-name@version
          PACKAGE_NAME=$(echo "$TAG_NAME" | sed 's/@\([^@]*\)$//')
          VERSION=$(echo "$TAG_NAME" | sed 's/.*@//')

          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Determine if this is a prerelease
          if [[ "$VERSION" == *"-beta."* ]] || [[ "$VERSION" == *"-alpha."* ]] || [[ "$VERSION" == *"-rc."* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate changelog for this version
        id: changelog
        run: |
          # Get the CHANGELOG.md from the specific package
          PACKAGE_PATH="${{ steps.tag_info.outputs.package_name }}"
          PACKAGE_DIR=$(echo "$PACKAGE_PATH" | sed 's/@askdialog\//packages\//')

          # Map package names to directories
          if [[ "$PACKAGE_PATH" == "@askdialog/dialog-sdk" ]]; then
            PACKAGE_DIR="packages/sdk"
          elif [[ "$PACKAGE_PATH" == "@askdialog/dialog-vue" ]]; then
            PACKAGE_DIR="packages/vue"
          fi

          CHANGELOG_FILE="$PACKAGE_DIR/CHANGELOG.md"

          if [ -f "$CHANGELOG_FILE" ]; then
            # Extract the changelog section for this version
            VERSION="${{ steps.tag_info.outputs.version }}"

            # Get changelog between version headers
            CHANGELOG_CONTENT=$(awk "/## $VERSION/,/## [0-9]/" "$CHANGELOG_FILE" | sed '1!{/## [0-9]/d;}')

            if [ -n "$CHANGELOG_CONTENT" ]; then
              echo "changelog<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "changelog=Release $VERSION" >> $GITHUB_OUTPUT
            fi
          else
            echo "changelog=Release $VERSION for $PACKAGE_PATH" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = '${{ steps.tag_info.outputs.tag_name }}';
            const packageName = '${{ steps.tag_info.outputs.package_name }}';
            const version = '${{ steps.tag_info.outputs.version }}';
            const isPrerelease = '${{ steps.tag_info.outputs.is_prerelease }}' === 'true';
            const changelog = `${{ steps.changelog.outputs.changelog }}`;

            const releaseName = `${packageName}@${version}`;

            let body = changelog;

            // Add npm link
            const npmPackageName = packageName.replace('@', '').replace('/', '-');
            body += `\n\n---\n\nðŸ“¦ [View on npm](https://www.npmjs.com/package/${packageName}/v/${version})`;

            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: releaseName,
                body: body,
                draft: false,
                prerelease: isPrerelease
              });

              console.log(`âœ… Created release for ${releaseName}`);
            } catch (error) {
              core.setFailed(`Failed to create release: ${error.message}`);
            }
